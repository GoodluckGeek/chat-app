<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatApp Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- Navbar for logged-in users -->
  <nav class="navbar" id="userNavbar" style="display: none;">
    <div class="nav-left">
      <button class="profile-icon" id="openProfilePanel" title="Profile">
        <img id="navbarAvatar" src="default.png" alt="Avatar">
      </button>
      <span id="myNumber" style="margin-left:1em;font-weight:bold;"></span>
    </div>
    <div class="nav-right">
      <button class="menu-icon" id="openMenuPanel" title="Menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- Profile Side Panel -->
  <div class="side-panel profile-panel" id="profilePanel" tabindex="-1">
    <button class="close-btn" id="closeProfilePanel" title="Close">&times;</button>
    <form id="profileForm" enctype="multipart/form-data">
      <img id="profilePanelAvatar" class="profile-avatar" src="default.png" alt="Avatar">
      <label for="profileUsername">Username</label>
      <input type="text" id="profileUsername" name="username" autocomplete="off">
      <label for="profileAvatar">Avatar</label>
      <input type="file" id="profileAvatar" name="avatar" accept="image/*">
      <button type="submit" class="btn">Save Changes</button>
    </form>
  </div>

  <!-- Menu Side Panel -->
  <div class="side-panel menu-panel" id="menuPanel" tabindex="-1">
    <button class="close-btn" id="closeMenuPanel" title="Close">&times;</button>
    <div class="menu-list">
      <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
      <a href="#" id="logoutNav" class="danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>
  <div class="side-overlay" id="sideOverlay"></div>

  <!-- Friend List -->
  <div class="container" id="friendListContainer" style="max-width: 400px;">
    <h2>Your Friends</h2>
    <div id="friendList" class="friend-list"></div>
    <div id="noFriends" style="color:#888;display:none;">No friends yet. Click the + button to add!</div>
  </div>

  <!-- Add Friend Dialog -->
  <div id="addFriendDialog" class="add-friend-dialog" style="display:none;">
    <div class="add-friend-content">
      <h3>Add Friend</h3>
      <input type="text" id="addFriendNumber" placeholder="Enter ChatApp Number">
      <div>
        <button id="addFriendSubmit" class="btn">Add</button>
        <button id="addFriendCancel" class="btn danger" type="button">Cancel</button>
      </div>
      <div id="addFriendError" style="color:#dc3545;"></div>
    </div>
  </div>

  <!-- Private Chat Panel -->
  <div id="privateChatPanel" class="private-chat-panel">
    <div class="private-chat-header">
      <img id="chatFriendAvatar" src="default.png" alt="Avatar">
      <div>
        <div id="chatFriendName" style="font-weight:bold;"></div>
        <div id="chatFriendNumber" style="font-size:0.95em;color:#888;"></div>
      </div>
      <button class="private-chat-close" id="closePrivateChat">&times;</button>
    </div>
    <div id="privateChatMessages" class="private-chat-messages"></div>
    <form id="privateChatForm" class="private-chat-input" autocomplete="off">
      <input type="text" id="privateMsgInput" placeholder="Type a message...">
      <input type="file" id="privateImgInput" accept="image/*" style="display:none;">
      <button type="button" id="privateImgBtn"><i class="fas fa-image"></i></button>
      <button type="submit" class="btn"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>

  <!-- Floating Add Friend Button -->
  <button class="fab-add" id="fabAddFriend" title="Add Friend"><i class="fas fa-user-plus"></i></button>

  
  <script>
    let myUsername = '', myAvatar = 'default.png', myNumber = '';
    let currentFriend = null, currentFriendData = null;
    let socket = null;

    // --- Panel logic ---
    function openPanel(panelId) {
      document.getElementById(panelId).classList.add('open');
      document.getElementById('sideOverlay').classList.add('open');
    }
    function closePanels() {
      document.getElementById('profilePanel').classList.remove('open');
      document.getElementById('menuPanel').classList.remove('open');
      document.getElementById('sideOverlay').classList.remove('open');
    }
    document.getElementById('openProfilePanel').onclick = function() { openPanel('profilePanel'); };
    document.getElementById('openMenuPanel').onclick = function() { openPanel('menuPanel'); };
    document.getElementById('closeProfilePanel').onclick = closePanels;
    document.getElementById('closeMenuPanel').onclick = closePanels;
    document.getElementById('sideOverlay').onclick = closePanels;

    // Avatar preview in profile panel
    document.getElementById('profileAvatar').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          document.getElementById('profilePanelAvatar').src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Profile form submit (update username/avatar)
    document.getElementById('profileForm').onsubmit = async function(e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append('username', document.getElementById('profileUsername').value.trim());
      const fileInput = document.getElementById('profileAvatar');
      if (fileInput.files[0]) {
        formData.append('avatar', fileInput.files[0]);
      }
      const token = localStorage.getItem('token');
      const res = await fetch('/me', {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      });
      const data = await res.json();
      if (res.ok) {
        if (data.token) {
          localStorage.setItem('token', data.token);
        }
        closePanels();
        loadUser();
      } else {
        alert(data.error || 'Profile update failed');
      }
    };

    // --- Auth and navbar logic ---
    async function loadUser() {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
        return;
      }
      const res = await fetch("/me", {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) {
        localStorage.removeItem("token");
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
        return;
      }
      const user = await res.json();
      myUsername = user.username;
      myAvatar = user.avatar || "default.png";
      myNumber = user.chatAppNumber;
      document.getElementById("userNavbar").style.display = "flex";
      document.getElementById("navbarAvatar").src = myAvatar;
      document.getElementById("profilePanelAvatar").src = myAvatar;
      document.getElementById("profileUsername").value = myUsername;
      document.getElementById("myNumber").textContent = "Your ChatApp Number: " + myNumber;
      loadFriends();
      if (!socket) {
        socket = io();
        socket.emit('join', { username: myUsername, avatar: myAvatar, chatAppNumber: myNumber });
      }
    }

    function logout(event) {
      if (event) event.preventDefault();
      localStorage.removeItem("token");
      fetch("/logout", { method: "POST" }).finally(() => {
        window.location.href = "login.html";
      });
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("logoutNav").addEventListener("click", logout);
      loadUser();
    });

    // --- Friend List ---
    async function loadFriends() {
      const token = localStorage.getItem("token");
      const res = await fetch("/friends", {
        headers: { "Authorization": "Bearer " + token }
      });
      const friends = await res.json();
      const friendList = document.getElementById("friendList");
      friendList.innerHTML = "";
      if (friends.length === 0) {
        document.getElementById("noFriends").style.display = "";
      } else {
        document.getElementById("noFriends").style.display = "none";
        friends.forEach(friend => {
          const div = document.createElement("div");
          div.className = "friend-item";
          div.innerHTML = `
            <img class="friend-avatar" src="${friend.avatar || 'default.png'}" alt="Avatar">
            <div class="friend-info">
              <div class="friend-name">${friend.username}</div>
              <div class="friend-number">${friend.chatAppNumber}</div>
            </div>
          `;
          div.onclick = () => openPrivateChat(friend);
          friendList.appendChild(div);
        });
      }
    }

    // --- Add Friend Dialog ---
    document.getElementById("fabAddFriend").onclick = function() {
      document.getElementById("addFriendDialog").style.display = "flex";
      document.getElementById("addFriendNumber").value = "";
      document.getElementById("addFriendError").textContent = "";
    };
    document.getElementById("addFriendCancel").onclick = function() {
      document.getElementById("addFriendDialog").style.display = "none";
    };
    document.getElementById("addFriendSubmit").onclick = async function(e) {
      e.preventDefault();
      const number = document.getElementById("addFriendNumber").value.trim();
      if (!number) return;
      const token = localStorage.getItem("token");
      const res = await fetch("/add-friend", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify({ chatAppNumber: number })
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById("addFriendDialog").style.display = "none";
        loadFriends();
      } else {
        document.getElementById("addFriendError").textContent = data.error || "Failed to add friend";
      }
    };

    // --- Private Chat ---
    function openPrivateChat(friend) {
      currentFriend = friend.chatAppNumber;
      currentFriendData = friend;
      document.getElementById("privateChatPanel").classList.add("open");
      document.getElementById("chatFriendAvatar").src = friend.avatar || "default.png";
      document.getElementById("chatFriendName").textContent = friend.username;
      document.getElementById("chatFriendNumber").textContent = friend.chatAppNumber;
      loadPrivateChat();
    }
    document.getElementById("closePrivateChat").onclick = function() {
      document.getElementById("privateChatPanel").classList.remove("open");
      document.getElementById("privateChatMessages").innerHTML = "";
      currentFriend = null;
    };

    async function loadPrivateChat() {
      const token = localStorage.getItem("token");
      const res = await fetch("/chat/" + currentFriend, {
        headers: { "Authorization": "Bearer " + token }
      });
      const messages = await res.json();
      const msgDiv = document.getElementById("privateChatMessages");
      msgDiv.innerHTML = "";
      messages.forEach(m => appendPrivateMsg(m));
      msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    function appendPrivateMsg(msg) {
      const div = document.createElement("div");
      div.className = "private-chat-msg" + (msg.from === myNumber ? " me" : "");
      div.innerHTML = `
        <img class="avatar" src="${msg.from === myNumber ? myAvatar : currentFriendData.avatar || 'default.png'}">
        <div class="private-chat-bubble">
          <span>${msg.text ? msg.text.replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""}</span>
          ${msg.image ? `<img src="${msg.image}" alt="img">` : ""}
          <span class="time">${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : ""}</span>
        </div>
      `;
      document.getElementById("privateChatMessages").appendChild(div);
    }

    // --- Socket.io for private chat ---
    function joinChat(user) {
      currentUser = user;
      socket.emit("join", user); // user must contain chatAppNumber
    }

    // Send a private message
    function sendMessage(to, text) {
      if (!currentUser) return;
      socket.emit("privateMessage", {
        to, text
      });
    }

    function ensureSocket() {
      if (!socket) {
        socket = io();
        socket.emit('join', { username: myUsername, avatar: myAvatar, chatAppNumber: myNumber });
      }
    }
    ensureSocket();

    // Listen for incoming private messages
    socket.on("privateMessage", (msg) => {
      console.log("New message:", msg);
      // TODO: update UI with the new message
    })

    socket && socket.on('privateMessage', function(msg) {
      if (currentFriend && (msg.from === myNumber && msg.to === currentFriend || msg.from === currentFriend && msg.to === myNumber)) {
        appendPrivateMsg(msg);
        const msgDiv = document.getElementById("privateChatMessages");
        msgDiv.scrollTop = msgDiv.scrollHeight;
      }
    });

    // --- Send private message ---
    document.getElementById("privateChatForm").onsubmit = function(e) {
      e.preventDefault();
      const text = document.getElementById("privateMsgInput").value.trim();
      if (!text && !window._imgToSend) return;
      ensureSocket();
      socket.emit('privateMessage', {
        to: currentFriend,
        text,
        image: window._imgToSend || null
      });
      document.getElementById("privateMsgInput").value = "";
      window._imgToSend = null;
      document.getElementById("privateImgInput").value = "";
    };

    // --- Image sending in private chat ---
    document.getElementById("privateImgBtn").onclick = function(e) {
      e.preventDefault();
      document.getElementById("privateImgInput").click();
    };
    document.getElementById("privateImgInput").onchange = function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          window._imgToSend = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    };
  </script>
</body>
</html>